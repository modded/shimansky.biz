if(!("console"in window)||!("firebug"in console)){var names="log,debug,info,warn,error,assert,dir,dirxml,group,groupEnd,time,timeEnd,count,trace,profile,profileEnd".split(",");window.console={};for(var i=0;i<names.length;++i)window.console[names[i]]=function(){}}var setValue,getValue,remValue; if(window._globalStorage){var glStorage=globalStorage.namedItem(document.domain);setValue=function(a,b){glStorage.setItem(a,b)};remValue=function(a){glStorage.removeItem(a)};getValue=function(a,b){var c=glStorage.getItem(a);return c?c.value:b}}else setValue=function(a,b){(!(b.length>4E3)||confirm("Warning.\n\nSession you're about to save exceeds 4000 characters thus it may not be saved correctly. If you need to save large session use browser supporting window.globalStorage.\n\nDo you want to save anyway?"))&& $.cookie(a,b,{expires:365})},remValue=function(a){$.cookie(a,"")},getValue=function(a,b){var c=$.cookie(a);return c?c:b}; var EmCalc={start:function(){this.appendOptionsHTML();this.readCookies();this.toggleChangelog();this.optionsTabs();this.listSessions();this.settingsActions();this.sessionActions()},number:/^[0-9\.]+$/,numberCanNeg:/^-?[0-9\.]+$/,messages:{},appendOptionsHTML:function(){var a=this;$.ajax({async:!1,type:"GET",url:"html.xml",dataType:"application/xml",success:function(b){$("#nojs").remove();$("#panel").prepend(b);$("dd").after('<div class="cl"></div>');$("#static").append('<div id="toggle">Toggle</div>'); a.resetNodeTree()}})},readCookies:function(){$.cookie("emcalc.toggle")?($("#panel").hide(),$("#toggle").toggle(this.showPanel,this.hidePanel)):$("#toggle").addClass("fix").toggle(this.hidePanel,this.showPanel);var a=$.cookie("emcalc.settings");if(a)a=a.split("#"),$("#fontSize").val(a[0]),$("#decimalPlaces").val(a[1]),console.log(a[2]),$("#askNodeNames")[0].checked=a[2]=="true"?!0:!1},hidePanel:function(){$(this).removeClass("fix");$("#panel").hide();$.cookie("emcalc.toggle","true",{expires:365})}, showPanel:function(){$(this).addClass("fix");$("#panel").show();$.cookie("emcalc.toggle","",{expires:365})},toggleChangelog:function(){var a=$("#text");a.hide();$("#more").toggle(function(){a.show()},function(){a.hide()})},resetNodeTree:function(){var a=document.createElement("ul"),b=document.createElement("li"),c=this.createNode("body",!0);$("#ems").empty().append(a).find("ul").attr("id","body").append(b).find("li").addClass("lv1");$(c).appendTo(b).find("input:first").focus()},recalculateNodes:function(){$("#body input:first").keyup()}, optionsTabs:function(){var a=$.cookie("curtab")||"sessions",b=$("#options").children("form"),c=$("#tabs a");b.not("#"+a).hide();c.bind("click",function(a){var e=this.href.split("#")[1];b.show().not("#"+e).hide();c.parent().removeClass("active");$(this).parent().addClass("active");$.cookie("curtab",e);a.preventDefault()}).filter('[@href="#'+a+'"]').parent().addClass("active")},changeFieldValue:function(a,b,c){if(b==38)a.value=a.value||0,a.value=parseInt(a.value)+1;else if(b==40)a.value=a.value||0, b=parseInt(a.value)-1,a.value=c?b:b>=0?b:0;else if(b==33)a.value=a.value||0,a.value=parseInt(a.value)+10;else if(b==34)a.value=a.value||0,b=parseInt(a.value)-10,a.value=c?b:b>=0?b:0},selectField:function(a){a.focus();if(!document.selection&&a.selectionStart&&a.selectionEnd)a.selectionStart=0,a.selectionEnd=a.value.length},settingsActions:function(){$("#settings").bind("submit",this.saveSettings).find("input[@type=text]").bind("keyup",this,function(a){var b=a.data;this.value.match(b.number)&&(b.changeFieldValue(this, a.charCode||a.keyCode||0,!1),b.recalculateNodes())})},saveSettings:function(a){var b=$("#fontSize").val(),c=$("#decimalPlaces").val(),d=$("#askNodeNames")[0].checked?"true":"";$.cookie("emcalc.settings",b+"#"+c+"#"+d,{expires:365});a.preventDefault()},editName:function(a){var a=a.data,b=document.createElement("input"),c=document.createElement("span");$(c).addClass("nodeNameEdit").append(b);$(b).addClass("edit").val($(this).text()).bind("keypress",this,function(a){var b=a.data,a=a.charCode||a.keyCode|| 0;a==13?((a=$(this).val())&&$(b).text(a),$(this.parentNode).remove(),$(b).show(),$(window).unbind("click")):a==27&&($(this.parentNode).remove(),$(b).show(),$(window).unbind("click"))});$(window).bind("click",this,function(a){var c=a.data;a.target!==b&&((a=$(b).val())&&$(c).text(a),$(b).remove(),$(c).show(),$(this).unbind("click"))});$(this).hide().before(c);a.selectField($(b)[0])},createNode:function(a,b,c){var c=c||"",d="",e="";b||(d='<a class="nodeSibling" href="#" title="Add sibling">[Add sibling]</a>', e='<a class="nodeDelete" href="#" title="Delete this node & child nodes">[Delete node]</a>');var a='<fieldset><span class="nodeName" title="Double click to edit">'+(a||"node")+'</span><span> { </span><span class="nodePxs"><input type="text" class="text"/></span><span> px = </span><span class="nodeEms"><input type="text" class="text readonly" readonly=""/></span><span> }</span><span class="nodeActs">'+d+'<a class="nodeChild" href="#" title="Add child">[Add child]</a></span>'+e+"</fieldset>",f=$("<form></form>"); f.html(a).bind("submit",function(a){a.preventDefault()}).find("span").filter(".nodeName").bind("dblclick",this,this.editName).end().filter(".nodePxs").find("input").val(c).bind("keyup",this,this.calcFields).end().end().filter(".nodeEms").find("input").bind("click",this,function(a){a.data.selectField(this)}).end().end().end().find("a").filter(".nodeSibling").bind("click",this,function(a){a.data.addNode(f[0],"sibling");a.preventDefault()}).end().filter(".nodeChild").bind("click",this,function(a){a.data.addNode(f[0], "child");a.preventDefault()}).end().filter(".nodeDelete").bind("click",this,this.deleteNode);return f},countPrevs:function(a){for(var a=a.previousSibling,b=0;a;)a.nodeType!=1&&b++,a=a.previousSibling;return b},addNode:function(a,b){var c=a.parentNode,d=parseInt(c.className.split("lv")[1])+(b=="sibling"?0:1);node=document.createElement("li");name="node"+d;$("#askNodeNames")[0].checked&&(name=prompt("Enter node name:")||name);$(node).addClass("lv"+d).append(this.createNode(name));b=="sibling"?$(c).after(node): (d=$(c).children("ul")[0])?d.appendChild(node):(d=document.createElement("ul"),d.appendChild(node),c.appendChild(d));this.savedStateHandler(!1);$(node).find("input:first").focus()},deleteNode:function(a){$(this.parentNode.parentNode.parentNode).remove();a.data.savedStateHandler(!1);a.preventDefault()},roundDecimals:function(a,b){return this.padZero(Math.round(a*Math.pow(10,b))/Math.pow(10,b),b)},padZero:function(a,b){var c=a.toString(),d=c.indexOf(".");d==-1?(len=0,c+=b>0?".":""):len=c.length-d-1; d=b-len;if(d>0)for(var e=1;e<=d;e++)c+="0";return c},calcFields:function(a){var b=a.data,a=a.charCode||a.keyCode||0;if(this.value.match(b.numberCanNeg)||this.value=="")b.changeFieldValue(this,a,!0),this.value&&b.savedStateHandler(!1);this.value.match(b.numberCanNeg)&&$.each($("#ems span.nodePxs input"),function(){var a=this.value,d="",e=this.parentNode.parentNode,d=e.parentNode.parentNode.parentNode,d=$(d).attr("id")=="body"?$("#fontSize").val():$(d.parentNode).find("form input.text:first").val(); d.match(b.number)&&$(e).find("input.text:nth(1)").val(b.pixToEm(d,a,$("#decimalPlaces").val())+"em")})},pixToEm:function(a,b,c){return this.roundDecimals(b/a,c)},nodePrefix:"_",sessionPrefix:"ss-",sessionsId:"sessions",sessionCurrent:0,sessionNewCreated:"",sessionMissing:"Error. Session hasn't been found.",savedConfirm:"Your current session isn't saved and will be lost. Do you want to proceed anyway?",savedState:!0,savedStateHandler:function(a){if(this.savedState!=a){this.savedState=a;var b=$("#sessionList option"); a?b.removeClass("unsaved"):b.filter("[@selected]").addClass("unsaved")}},saveSession:function(a){function b(a,b,c){var d=a.splice(b),a=a.splice(0,b);a.push(c);return a=a.concat(d)}var c=a.data,d=[];$("#body li").each(function(a){this.id=c.nodePrefix+a;var b=$(this).children("form").find("span");d[a]={n:b.filter(".nodeName").text(),p:b.filter(".nodePxs").find("input").val(),a:this.parentNode.parentNode.id.replace(c.nodePrefix,""),c:this.className.replace("lv","")}});var a=$.toJSON(d),e;if(c.sessionCurrent== 0){var f=c.returnSessionList(),g=0;if(f){g=sessionsNamesLen=f.length;console.log("newSessionIndex: ",g,"sessionsNamesLen: ",sessionsNamesLen);for(e=0;e<sessionsNamesLen;e++){var h=parseInt(f[e].v.replace(c.sessionPrefix,""));console.log("number: ",h,"i: ",e);if(h!=e){g=e;console.log("newSessionIndex: ",g);console.log(c.sessionPrefix+g);break}}}else f=[];if(h=prompt("Podaj name",""))e=c.sessionPrefix+g,f=b(f,g,{n:h,v:e}),setValue(c.sessionsId,$.toJSON(f)),setValue(e,a),c.sessionNewCreated=e}else e= $("#sessionList option")[c.sessionCurrent].value,setValue(e,a);c.listSessions();c.savedStateHandler(!0)},returnSessionList:function(){var a=getValue(this.sessionsId,"");a&&(a=$.parseJSON(a));return a},loadSession:function(a){var b=a.data,a=a.target,c=a.nodeName.toLowerCase(),d;c=="select"&&(a=$("option:last",a)[0],d=!0);if(c=="option"||d)if(d=!0,b.savedState||(d=confirm(b.savedConfirm)?!0:!1),d){b.sessionCurrent=a.index;d=$("#body");if(a.index==0)a=document.createElement("li"),d.empty().append(a).find("li").addClass("lv1").append(b.createNode("body", !0)).find("input:first").focus();else if(a=getValue(a.value,"")){a=$.parseJSON(a);d.empty();for(c=0;c<a.length;c++){var e=a[c],f=c==0?!0:!1,g=b.createNode(e.n,f,e.p),h=document.createElement("li");h.id=b.nodePrefix+c;h.className="lv"+e.c;f?d.append(h):(e=$("#"+b.nodePrefix+e.a),f=e.find("ul:first"),f.length||(f=$(document.createElement("ul")),e.append(f)),f.append(h));$("#"+b.nodePrefix+c).append(g)}d.children("li:first").children("form").find("span.nodePxs input").trigger("keyup")}else alert(b.sessionMissing); b.savedStateHandler(!0)}else $("#sessionList").blur().find("option")[b.sessionCurrent].selected=!0},deleteSession:function(a){a=a.data;if(a.sessionCurrent!=0&&confirm("Do you really want to delete this session?")){var b=$("#sessionList option"),c=b[a.sessionCurrent].value,d=a.returnSessionList(),e=-1;if(d){for(var f=0;f<d.length;f++)d[f].v==c&&(e=f);if(e!=-1)d.length==1?d=[]:e==0?d.splice(0,1):d.splice(e,e),data=$.toJSON(d),setValue(a.sessionsId,data),remValue(c),b.filter('[@value="'+c+'"]').remove(), b[0].selected=!0,a.sessionCurrent=0,a.resetNodeTree()}}},listSessions:function(){var a=$("#sessionList select");a.find("option").not(".new").remove();var b=$("#sessionLoad"),c=this.returnSessionList();if(c){a.add(b).removeAttr("disabled");for(b=0;b<c.length;b++){var d=c[b];a.append('<option value="'+d.v+'">'+d.n+"</option>")}}else a.empty().append('<option class="new" selected="selected">New session</option>').add(b).attr("disabled","disabled");var a=a.find("option"),e=this;if(this.sessionNewCreated)a.each(function(){if(this.value== e.sessionNewCreated)e.sessionCurrent=this.index}),this.sessionNewCreated="";a[this.sessionCurrent].selected=!0},sessionActions:function(){$("#sessionList").bind("click",this,this.loadSession);$("#sessionSave").bind("click",this,this.saveSession);$("#sessionDelete").bind("click",this,this.deleteSession);$("#sessions").bind("submit",function(a){a.preventDefault()})}};$().ready(function(){EmCalc.start()});
